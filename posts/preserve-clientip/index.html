

<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="robots" content="index, follow"><link rel="author" href="/humans.txt">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">
<meta name="theme-color" content="#494f5c">
<meta name="msapplication-TileColor" content="#494f5c">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#494f5c"><meta name="author" content="Steven Schramm">

  <meta itemprop="name" content="AVI NSX Cloud - Is it possible to preserve the client IP for traffic forwarded by a One-Arm LoadBalancer?">
  <meta itemprop="description" content="Introduction LoadBalancing is a crucial feature to increase the availability and reduce the time to complete a failover for IT services. In the first moment it seems to be not to complex. You have multiple instances of your service and you forward the traffic to both of those instances to share the load. But there a dozens of different applications and services with totally different requirements. Some of those applications are very simple and are dependent to local sessions or states inside a database. Other applications are stateless or the state is synced between the different instances. Based on those requirements the following LoadBalancing features are a subset of the important features to understand.">
  <meta itemprop="datePublished" content="2025-01-11T03:35:00+01:00">
  <meta itemprop="dateModified" content="2025-01-11T03:35:00+01:00">
  <meta itemprop="wordCount" content="2016">
  <meta itemprop="keywords" content="Homelab,Nested Lab,Vmware,Network,Nsx,Loadsharing,High Availability,AVI,NSX ALB,LoadBalancer,Advanced LoadBalancer"><meta property="og:url" content="https://sdn-techtalk.com/posts/preserve-clientip/">
  <meta property="og:site_name" content="SDN-Techtalk | Steven Schramm">
  <meta property="og:title" content="AVI NSX Cloud - Is it possible to preserve the client IP for traffic forwarded by a One-Arm LoadBalancer?">
  <meta property="og:description" content="Introduction LoadBalancing is a crucial feature to increase the availability and reduce the time to complete a failover for IT services. In the first moment it seems to be not to complex. You have multiple instances of your service and you forward the traffic to both of those instances to share the load. But there a dozens of different applications and services with totally different requirements. Some of those applications are very simple and are dependent to local sessions or states inside a database. Other applications are stateless or the state is synced between the different instances. Based on those requirements the following LoadBalancing features are a subset of the important features to understand.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-01-11T03:35:00+01:00">
    <meta property="article:modified_time" content="2025-01-11T03:35:00+01:00">
    <meta property="article:tag" content="Homelab">
    <meta property="article:tag" content="Nested Lab">
    <meta property="article:tag" content="Vmware">
    <meta property="article:tag" content="Network">
    <meta property="article:tag" content="Nsx">
    <meta property="article:tag" content="Loadsharing">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="AVI NSX Cloud - Is it possible to preserve the client IP for traffic forwarded by a One-Arm LoadBalancer?">
  <meta name="twitter:description" content="Introduction LoadBalancing is a crucial feature to increase the availability and reduce the time to complete a failover for IT services. In the first moment it seems to be not to complex. You have multiple instances of your service and you forward the traffic to both of those instances to share the load. But there a dozens of different applications and services with totally different requirements. Some of those applications are very simple and are dependent to local sessions or states inside a database. Other applications are stateless or the state is synced between the different instances. Based on those requirements the following LoadBalancing features are a subset of the important features to understand.">

<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "AVI NSX Cloud - Is it possible to preserve the client IP for traffic forwarded by a One-Arm LoadBalancer?",
    "name": "AVI NSX Cloud - Is it possible to preserve the client IP for traffic forwarded by a One-Arm LoadBalancer?",
    "description": "Introduction LoadBalancing is a crucial feature to increase the availability and reduce the time to complete a failover for IT services. In the first moment it seems to be not to complex. You have multiple instances of your service and you forward the traffic to both of those instances to share the load. But there a dozens of different applications and services with totally different requirements. Some of those applications are very simple and are dependent to local sessions or states inside a database. Other applications are stateless or the state is synced between the different instances. Based on those requirements the following LoadBalancing features are a subset of the important features to understand.\n",
    "keywords": ["homelab", "nested lab", "vmware", "network", "nsx", "loadsharing", "High Availability", "AVI", "NSX ALB", "LoadBalancer", "Advanced LoadBalancer"],
    "articleBody": "Introduction LoadBalancing is a crucial feature to increase the availability and reduce the time to complete a failover for IT services. In the first moment it seems to be not to complex. You have multiple instances of your service and you forward the traffic to both of those instances to share the load. But there a dozens of different applications and services with totally different requirements. Some of those applications are very simple and are dependent to local sessions or states inside a database. Other applications are stateless or the state is synced between the different instances. Based on those requirements the following LoadBalancing features are a subset of the important features to understand.\nSession Persistency based on Source IP or HTTP cookies Content Switching to manipulate L7 information like the HTTP header Active Monitors to track the availability of a appliaction and mark these application as UP or DOWN NAT to hide the IP of the User (Client) behind the IP of the LoadBalancer Forwarding the real client IP of the User Port Translation to forward traffic to a different Port in the backend compared to the port used by the user Further a LoadBalancer is a active component where all the traffic from the clients is sent to, before the traffic is getting forwarded to the application instances in the backend. To get this done the Loadbalancer requires network connectivity in at leat one subnet, but it can also be the case that the LoadBalancer does have multiple subnets assigned. Therefore the following two deployment options of a LoadBalancer are commonly used.\nOne-Arm Loadbalancer (one subnet is assigned) Two-Arm LoadBalancer (two or more subnets are assigned) If you are using a One-Arm LoadBalancer the packets forwarded to the backend applications should be tranlated, so the IP of the LoadBalancer is visible in the IP header of the packet and the reponses are sent over the LoadBalancer. Otherwhise the response traffic would be sent toto the default gateway and the LoadBalancer is unable to track the state of the communication streams. Instead of translating the the source IP of the communication it would be an option to use the LoadBalancer as default gateway for the backend servers hosting the applications. For an One-Arm LoadBalancer this is commonly not possible, since the applications are running in different subnets and the gateway cannot be set to the LoadBalancer IP.\nOne solution for this challenge is to assign multiple subnets to the LoadBalancer, where one subnet is used for the communication comming from the clients and the second interface is in the same subnet as the backend applications.\nFor AVI the solution of a Two-Arm LoadBalancer can be used for integartions with the vCenter cloud, but not if the integration is done by using the NSX cloud. The only supported setup for AVI NSX cloud implementations is using One-Arm Loadbalancers. Beside this limitation the NSX Cloud does have multiple advantages and the following list shows some examples.\nAutomated statice rout creation to forward traffic from a T1 router to the desired service engine. Easier implementation of Active/Acive Loadbalancers vCenter Cloud Scaling Limit (native scaleout): 4 Service Engines vCenter Cloud Scaling Limit (BGP for AVI): 64 Service Engines –\u003e High complexity NSX Cloud Scaling limit: 8 Service Engines –\u003e Automated by using automated static routes Since AVI with the NSX cloud is mandadory for the integration of specific VMware solutions like Cloud Director, it would be important to have the opportunity to forward the client IP to the bakend applications. There might be some other features like X-Forwarded-For which can be used to get the client IP visible in log files, but sometimes forwarding the original client IP as part of the IP header is just required.\nGood news, there is a solution for this challenge by using the feature “Preserve Client IP for NSX-T Overlay”, which will be the focus of this blog post. This blog post does not explain how to setup AVI with NSX Cloud from scratch, it just shows you how to implement the preserve client IP feature.\nIf you are interested how the integration of the NSX cloud is done, you can check the blog post “vSphere with Tanzu AKO integration for Ingress”. This blog is about the AKO integration for tanzu, but also describes how to configure the NSX cloud. for AVI.\nLab environment Three nested ESXi hosts of version 8.0.3, 24022510 vCenter server of version 8.0.3, 24022515 NSX Datacenter version 4.2.1.1 AVI version 22.1.7 VyOS Router Alpine test VM The following drawing shows an overview of the network connections, where the AVI Service Engines and the backend applications are connected. The drawing shows two backend services, but I am using a single Alpine VM as backend which is sufficient to validate that the real client IP is forwarded.\nHow is preserve client ip working for NSX Cloud? The challenge is to get the real client IP forwarded to the backend application and force the response traffic to be sent back to the LoadBalancer. Under normal circumstances this will not work for a One-Arm LoadBalancer, since the LoadBalancer is not in the datapath of the backend applications. Inested the backend application does use the T1 router as default gateway and the T1 router forwards the traffic to the T0 router. Based on this behavior the AVI Service Engines will see the packets sent from the client, but not the response. As solution the T1 router will be forced to sent the reponse traffic to a Floating IP configured on the AVI Service Engines, which will be taken from the AVI Data segment (NSX ALB Data from the drawing above). This enforcment is done by the service insertion framework of NSX and takes care that the response traffic comming from the defined backend application is sent to the Floating IP of the avtive Service Engine.\nRequirements to configure preserve client IP for NSX-T Overlay The useage of preserve client IP is dependent on very specific requirements which are shown in the following list.\nThe Service Engine Group used have to be configure for HA mode Active/ Standby The NSX-T user for configuring NSX-T cloud should have additional permissions of Netx Partner Admin and Security Admin for the preserve client IP functionality apart from the Network Admin requirement for other use cases (See Configuring NSX-T Roles for more details). Set URPF Mode to None for the VIP data segments in which the preserve client IP feature will be enabled. Ensure that Virtual Services (for which Preserve Client IP is configured) have Pools defined using NSX Network Security Groups. The Network Security Group will be configured as the Source match in the redirect rule. This ensures consistency between the redirect rule in NSX and the Pool membership in Avi Load Balancer. It is not supported to use IP addresses, ranges, IP Groups or DNS names for these Pools. AVI Data Segment and backend application needs to be connected to the same T1 router The requirements are also visible under the official documentation “Pre-Requisites to Configure Preserve Client IP for NSX-T Overlay”\nConfiguring Preserve Client IP To enable the service insertion, you need to gather the free IPs of the NSX ALB data segmenet first. Those IPs should not be used in any static IP or DHCP pool. The following command can be used to discover the DHCP range used for this segment\n[admin:10-0-1-18]: \u003e show nsxt segment seg-preserveclientip-sedata +--------------------+---------------------------------------------+ | Field | Value | +--------------------+---------------------------------------------+ | uuid | segmentruntime-0897fb3696cf | | segment_id | /infra/segments/seg-preserveclientip-sedata | | name | seg-preserveclientip-sedata | | subnet | 192.168.255.16/28 | | dhcp_enabled | True | | nw_ref | seg-preserveclientip-sedata | | nw_name | seg-preserveclientip-sedata | | vrf_context_ref | t1-preserveclientip-test | | tier1_id | /infra/tier-1s/t1-preserveclientip-test | | opaque_network_id | d509b42e-5db6-4458-9543-17a582fe1e40 | | segment_gw | 192.168.255.17/28 | | dhcp_ranges[1] | 192.168.255.19-192.168.255.30 | | segname | seg-preserveclientip-sedata | | tenant_ref | admin | | cloud_ref | nsx.lab.home | | security_only_nsxt | False | +--------------------+---------------------------------------------+ The next output shows the desired configuration for the network service configuration, where 192.168.255.18 is the floating IP. Other parameters like the SE Group reference, the VRF reference and the Cloud reference needs to be configured as well for the network service.\n[admin:10-0-1-18]: \u003e show networkservice nsxtpreserveclientip_sedata +--------------------------------+-----------------------------------------------------+ | Field | Value | +--------------------------------+-----------------------------------------------------+ | uuid | networkservice-26edbb45-5524-41a9-8abb-87250ab31494 | | name | nsxtpreserveclientip_sedata | | se_group_ref | seg-preserve-clientip | | vrf_ref | t1-preserveclientip-test | | service_type | ROUTING_SERVICE | | routing_service | | | enable_routing | False | | routing_by_linux_ipstack | False | | floating_intf_ip[1] | 192.168.255.18 | | enable_vmac | False | | enable_vip_on_all_interfaces | True | | advertise_backend_networks | False | | graceful_restart | False | | enable_auto_gateway | False | | tenant_ref | admin | | cloud_ref | nsx.lab.home | +--------------------------------+-----------------------------------------------------+ To execute the configuration, you need to switch to the config context of the network service by using the following command.\nconfigure networkservice There you can configure the desired configuration parameters.\nAfter the network service is created you can proceed configure the LoadBalancing Service to enable the preserve client IP feature. Therefore it is required to configure a new application profile with preserve client IP enabled. YOu are also allowed to adjust a existing application profile, but I would recommend to create a dedicated profile. For the application profile you need to take care, if you want to enable preserve Client IP for L7 or L4 services. If you want to enable it for an L4 service, you need to configure the L4 application profile. If you are trying to configure a L7 service, just create a L7 application profile.\nThe following screenshots visulizes the configuration parameters for a L4 application profile.\nAfter the application profile is created, you need to assign it in the specific virtual service, weher preserve client Ip should be enabled.\nAs last step you should validate, if you backend pool is configured with a NSX security group, which discovers the logical port of the backend applications. If the IP for the pool member is added manually in AVI, the service insertion cannot be applied. The following screenshot shows a example configuration of a well configured pool assignment.\nTesting For my tests I have teh following steup:\nLoadBalancer VIP: 10.100.11.10 Alpine IP: 10.100.12.2 ClientIP: 192.168.178.226 Test Protocol: SSH Validating which IP arrives at the backend application: tcpdump -i eth0 port 22 The following screenshot proved that the client IP is forwarded to the alpine.\nFurther the following command shows the ssh connection in the session table of the T1 service router.\nnsxe01(tier1_sr[3])\u003e get firewall connection state Sat Jan 11 2025 UTC 02:27:58.672 Connection count: 1 192.168.178.26:59870 -\u003e 10.100.11.10:22 dir in protocol tcp state ESTABLISHED:ESTABLISHED f-8168 n-0 Troubleshooting Under normal circumstances the configuration should work, if all of the requirements are fulfilled, but at some point you might have the situation it will not work. In such a situation it is important to understand how the specific setup can be analyzed to check, if the service insertion is working or not.\nI spent some time to find how to get some insights regarding the packet hits or where a packet capture would be helpful. So far, I just found the following command to see the packet hits for the configured service insertion.\nnsxe01\u003e get service-insertion Sat Jan 11 2025 UTC 02:14:11.958 Service Insertion Policy: Policy UUID : ab15ceaf-5c0c-4aeb-9efb-1b28d760fe2b Transport type : L3_ROUTED Is EW policy : 0 Redirected packet count : 10 Nexthop IP : 192.168.255.18 As you can see, there is a parameter for Redirected packet count which increases, if the connection is working as expected. If the backend pool member is not configured properly, the packet count will not be increased after testing the communication.\nObservations As soon as preserve client IP is configured for a LoadBalancing service based on service insertion for a NSX-T Overlay implementation with the NSX cloud, the backend application is no longer directly available over the same protocol and port. In my example I configured the LoadBalancing service for SSH and the command ssh 10.100.12.2 is running in an timeout, but ICMP is still working.\n",
    "wordCount" : "2016",
    "inLanguage": "en",
    "datePublished": "2025-01-11T03:35:00+01:00",
    "dateModified": "2025-01-11T03:35:00+01:00",
    "author":{
        "@type": "Person",
        "name": "Steven Schramm",
        "url": "https://sdn-techtalk.com/about/"
        },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://sdn-techtalk.com/posts/preserve-clientip/"
    },
    "publisher": {
      "@type": "Organization",
      "name": "SDN-Techtalk | Steven Schramm",
      "description": "",
      "logo": {
        "@type": "ImageObject",
        "url": "https://sdn-techtalk.com/favicon.ico"
      }
    }
}
</script><title>AVI NSX Cloud - Is it possible to preserve the client IP for traffic forwarded by a One-Arm LoadBalancer?</title>
<link rel="stylesheet dns-prefetch preconnect preload prefetch" as="style" href="https://sdn-techtalk.com/css/style.min.5c8d6d17b88c7b7d66d60851d5eaab8d6264b4f1f602f57a704fac1db6716b4c.css" integrity="sha256-XI1tF7iMe31m1ghR1eqrjWJktPH2AvV6cE+sHbZxa0w=" crossorigin="anonymous">
	</head>
<body id="page">
	<header id="site-header">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://sdn-techtalk.com/">SDN-Techtalk | Steven Schramm</a>
				</div>
				<nav class="site-nav hide-in-mobile"><a href="https://sdn-techtalk.com/posts/">Posts</a><a href="https://sdn-techtalk.com/about/">About Me</a></nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-links hide-in-mobile"><a href="https://www.linkedin.com/in/steven-schramm-87083113a" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
   <rect x="2" y="9" width="4" height="12"></rect>
   <circle cx="4" cy="4" r="2"></circle>
</svg></a></span><button id="share-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2">
      <circle cx="18" cy="5" r="3"></circle>
      <circle cx="6" cy="12" r="3"></circle>
      <circle cx="18" cy="19" r="3"></circle>
      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
   </svg></button>
 
<div id="share-links" class="animated fast">
    
    
    
    
    <ul>
        <li>
            <a href="https://twitter.com/intent/tweet?hashtags=hermit2&amp;url=https%3a%2f%2fsdn-techtalk.com%2fposts%2fpreserve-clientip%2f&amp;text=AVI%20NSX%20Cloud%20-%20Is%20it%20possible%20to%20preserve%20the%20client%20IP%20for%20traffic%20forwarded%20by%20a%20One-Arm%20LoadBalancer%3f" target="_blank" rel="noopener" aria-label="Share on X"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path class="st0" d="m21.3 21.1 -11.4 -18.2h-7.2l11.4 18.2zm-18.6 0 7.2 -6.6m4.2 -5 7.2 -6.6" />
</svg></a>
        </li>
        <li>
            <a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsdn-techtalk.com%2fposts%2fpreserve-clientip%2f" target="_blank" rel="noopener" aria-label="Share on Facebook"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
</svg></a>
        </li>
        <li>
            <a href="mailto:?subject=AVI%20NSX%20Cloud%20-%20Is%20it%20possible%20to%20preserve%20the%20client%20IP%20for%20traffic%20forwarded%20by%20a%20One-Arm%20LoadBalancer%3f&amp;body=https%3a%2f%2fsdn-techtalk.com%2fposts%2fpreserve-clientip%2f" target="_self" rel="noopener" aria-label="Share on Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
   <polyline points="22,6 12,13 2,6"></polyline>
</svg></a>
        </li>
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsdn-techtalk.com%2fposts%2fpreserve-clientip%2f&amp;source=https%3a%2f%2fsdn-techtalk.com%2f&amp;title=AVI%20NSX%20Cloud%20-%20Is%20it%20possible%20to%20preserve%20the%20client%20IP%20for%20traffic%20forwarded%20by%20a%20One-Arm%20LoadBalancer%3f&amp;summary=AVI%20NSX%20Cloud%20-%20Is%20it%20possible%20to%20preserve%20the%20client%20IP%20for%20traffic%20forwarded%20by%20a%20One-Arm%20LoadBalancer%3f%2c%20by%20Steven%20Schramm%0a%0a%3cnil%3e%0a" target="_blank" rel="noopener" aria-label="Share on LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
   <rect x="2" y="9" width="4" height="12"></rect>
   <circle cx="4" cy="4" r="2"></circle>
</svg></a>
        </li>
        <li>
            <a href="#" onclick="linkShare(&#34;AVI NSX Cloud - Is it possible to preserve the client IP for traffic forwarded by a One-Arm LoadBalancer?&#34;,&#34;https://sdn-techtalk.com/posts/preserve-clientip/&#34;,&#34;AVI NSX Cloud - Is it possible to preserve the client IP for traffic forwarded by a One-Arm LoadBalancer?, by Steven Schramm\n\n\u003cnil\u003e\n&#34;); return false;" target="_self" rel="noopener" aria-label="Copy Link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
   </svg></a>
        </li>
    </ul>
</div><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
   </svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://sdn-techtalk.com/posts/">Posts</a></li>
			<li><a href="https://sdn-techtalk.com/about/">About Me</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster"><article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jan 11, 2025</span></div>
				<h1>AVI NSX Cloud - Is it possible to preserve the client IP for traffic forwarded by a One-Arm LoadBalancer?</h1>
			</header>
			<div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
   stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather">
   <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
   <line x1="16" y1="8" x2="2" y2="22"></line>
   <line x1="17.5" y1="15" x2="9" y2="15"></line>
</svg><a href="/about/" target="_blank">Steven Schramm</a></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon">
      <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
      <line x1="7" y1="7" x2="7" y2="7"></line>
   </svg><span class="tag"><a href="https://sdn-techtalk.com/tags/homelab">homelab</a></span><span class="tag"><a href="https://sdn-techtalk.com/tags/nested-lab">nested lab</a></span><span class="tag"><a href="https://sdn-techtalk.com/tags/vmware">vmware</a></span><span class="tag"><a href="https://sdn-techtalk.com/tags/network">network</a></span><span class="tag"><a href="https://sdn-techtalk.com/tags/nsx">nsx</a></span><span class="tag"><a href="https://sdn-techtalk.com/tags/loadsharing">loadsharing</a></span><span class="tag"><a href="https://sdn-techtalk.com/tags/high-availability">High Availability</a></span><span class="tag"><a href="https://sdn-techtalk.com/tags/avi">AVI</a></span><span class="tag"><a href="https://sdn-techtalk.com/tags/nsx-alb">NSX ALB</a></span><span class="tag"><a href="https://sdn-techtalk.com/tags/loadbalancer">LoadBalancer</a></span><span class="tag"><a href="https://sdn-techtalk.com/tags/advanced-loadbalancer">Advanced LoadBalancer</a></span></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
      <polyline points="10 9 9 9 8 9"></polyline>
   </svg>2016 Words
     Words // ReadTime
    
    
    
    9 Minutes, 9 Seconds</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
   </svg>2025-01-11 03:35 &#43;0100</p></div>
			<hr class="post-end">
			<div class="content">
				<h2 id="introduction">Introduction<a href="#introduction" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>LoadBalancing is a crucial feature to increase the availability and reduce the time to complete a failover for IT services. In the first moment it seems to be not to complex. You have multiple instances of your service and you forward the traffic to both of those instances to share the load.
But there a dozens of different applications and services with totally different requirements. Some of those applications are very simple and are dependent to local sessions or states inside a database. Other applications are stateless or the state is synced between the different instances.
Based on those requirements the following LoadBalancing features are a subset of the important features to understand.</p>
<ul>
<li>Session Persistency based on Source IP or HTTP cookies</li>
<li>Content Switching to manipulate L7 information like the HTTP header</li>
<li>Active Monitors to track the availability of a appliaction and mark these application as UP or DOWN</li>
<li>NAT to hide the IP of the User (Client) behind the IP of the LoadBalancer</li>
<li>Forwarding the real client IP of the User</li>
<li>Port Translation to forward traffic to a different Port in the backend compared to the port used by the user</li>
</ul>
<p>Further a LoadBalancer is a active component where all the traffic from the clients is sent to, before the traffic is getting forwarded to the application instances in the backend. To get this done the Loadbalancer requires network connectivity in at leat one subnet, but it can also be the case that the LoadBalancer does have multiple subnets assigned.
Therefore the following two deployment options of a LoadBalancer are commonly used.</p>
<ul>
<li>One-Arm Loadbalancer (one subnet is assigned)</li>
<li>Two-Arm LoadBalancer (two or more subnets are assigned)</li>
</ul>
<p>If you are using a One-Arm LoadBalancer the packets forwarded to the backend applications should be tranlated, so the IP of the LoadBalancer is visible in the IP header of the packet and the reponses are sent over the LoadBalancer. Otherwhise the response traffic would be sent toto the default gateway and the LoadBalancer is unable to track the state of the communication streams.
Instead of translating the the source IP of the communication it would be an option to use the LoadBalancer as default gateway for the backend servers hosting the applications.
For an One-Arm LoadBalancer this is commonly not possible, since the applications are running in different subnets and the gateway cannot be set to the LoadBalancer IP.</p>
<p>One solution for this challenge is to assign multiple subnets to the LoadBalancer, where one subnet is used for the communication comming from the clients and the second interface is in the same subnet as the backend applications.</p>
<p>For AVI the solution of a Two-Arm LoadBalancer can be used for integartions with the vCenter cloud, but not if the integration is done by using the NSX cloud. The only supported setup for AVI NSX cloud implementations is using One-Arm Loadbalancers.
Beside this limitation the NSX Cloud does have multiple advantages and the following list shows some examples.</p>
<ul>
<li>Automated statice rout creation to forward traffic from a T1 router to the desired service engine.</li>
<li>Easier implementation of Active/Acive Loadbalancers
<ul>
<li>vCenter Cloud Scaling Limit (native scaleout): 4 Service Engines</li>
<li>vCenter Cloud Scaling Limit (BGP for AVI): 64 Service Engines &ndash;&gt; High complexity</li>
<li>NSX Cloud Scaling limit: 8 Service Engines &ndash;&gt; Automated by using automated static routes</li>
</ul>
</li>
</ul>
<p>Since AVI with the NSX cloud is mandadory for the integration of specific VMware solutions like Cloud Director, it would be important to have the opportunity to forward the client IP to the bakend applications.
There might be some other features like <code>X-Forwarded-For</code> which can be used to get the client IP visible in log files, but sometimes forwarding the original client IP as part of the IP header is just required.</p>
<p>Good news, there is a solution for this challenge by using the feature &ldquo;Preserve Client IP for NSX-T Overlay&rdquo;, which will be the focus of this blog post.
This blog post does not explain how to setup AVI with NSX Cloud from scratch, it just shows you how to implement the preserve client IP feature.</p>
<p>If you are interested how the integration of the NSX cloud is done, you can check the blog post <a href="https://evoila.com/blog/vsphere-with-tanzu-ako-integration-for-ingress/">&ldquo;vSphere with Tanzu AKO integration for Ingress&rdquo;</a>. This blog is about the AKO integration for tanzu, but also describes how to configure the NSX cloud. for AVI.</p>
<h2 id="lab-environment">Lab environment<a href="#lab-environment" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<ul>
<li>Three nested ESXi hosts of version 8.0.3, 24022510</li>
<li>vCenter server of version 8.0.3, 24022515</li>
<li>NSX Datacenter version 4.2.1.1</li>
<li>AVI version 22.1.7</li>
<li>VyOS Router</li>
<li>Alpine test VM</li>
</ul>
<p>The following drawing shows an overview of the network connections, where the AVI Service Engines and the backend applications are connected. The drawing shows two backend services, but I am using a single Alpine VM as backend which is sufficient to validate that the real client IP is forwarded.</p>
<p><a href="AVIPreseveClientIP.png"><img src="AVIPreseveClientIP.png" alt="architecture-overview"></a></p>
<h2 id="how-is-preserve-client-ip-working-for-nsx-cloud">How is preserve client ip working for NSX Cloud?<a href="#how-is-preserve-client-ip-working-for-nsx-cloud" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>The challenge is to get the real client IP forwarded to the backend application and force the response traffic to be sent back to the LoadBalancer. Under normal circumstances this will not work for a One-Arm LoadBalancer, since the LoadBalancer is not in the datapath of the backend applications.
Inested the backend application does use the T1 router as default gateway and the T1 router forwards the traffic to the T0 router. Based on this behavior the AVI Service Engines will see the packets sent from the client, but not the response.
As solution the T1 router will be forced to sent the reponse traffic to a Floating IP configured on the AVI Service Engines, which will be taken from the AVI Data segment (NSX ALB Data from the drawing above).
This enforcment is done by the service insertion framework of NSX and takes care that the response traffic comming from the defined backend application is sent to the Floating IP of the avtive Service Engine.</p>
<h2 id="requirements-to-configure-preserve-client-ip-for-nsx-t-overlay">Requirements to configure preserve client IP for NSX-T Overlay<a href="#requirements-to-configure-preserve-client-ip-for-nsx-t-overlay" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>The useage of preserve client IP is dependent on very specific requirements which are shown in the following list.</p>
<ul>
<li>The Service Engine Group used have to be configure for HA mode Active/ Standby</li>
<li>The NSX-T user for configuring NSX-T cloud should have additional permissions of Netx Partner Admin and Security Admin for the preserve client IP functionality apart from the Network Admin requirement for other use cases (See Configuring NSX-T Roles for more details).</li>
<li>Set URPF Mode to None for the VIP data segments in which the preserve client IP feature will be enabled.</li>
<li>Ensure that Virtual Services (for which Preserve Client IP is configured) have Pools defined using NSX Network Security Groups. The Network Security Group will be configured as the Source match in the redirect rule. This ensures consistency between the redirect rule in NSX and the Pool membership in Avi Load Balancer. It is not supported to use IP addresses, ranges, IP Groups or DNS names for these Pools.</li>
<li>AVI Data Segment and backend application needs to be connected to the same T1 router</li>
</ul>
<p>The requirements are also visible under the official documentation <a href="https://techdocs.broadcom.com/us/en/vmware-security-load-balancing/avi-load-balancer/avi-load-balancer/30-2/vmware-avi-load-balancer-installation-guide/installing-nsx-alb-in-vmware-nsx-t-environments/preserve-client-ip-for-nsx-t-overlay/pre-requisites-to-configure-preserve-client-ip-for-nsx-t-overlay.html">&ldquo;Pre-Requisites to Configure Preserve Client IP for NSX-T Overlay&rdquo;</a></p>
<h2 id="configuring-preserve-client-ip">Configuring Preserve Client IP<a href="#configuring-preserve-client-ip" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>To enable the service insertion, you need to gather the free IPs of the NSX ALB data segmenet first. Those IPs should not be used in any static IP or DHCP pool. The following command can be used to discover the DHCP range used for this segment</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">[admin:10-0-1-18]: &gt; show nsxt segment seg-preserveclientip-sedata
</span></span><span class="line"><span class="cl">+--------------------+---------------------------------------------+
</span></span><span class="line"><span class="cl">| Field              | Value                                       |
</span></span><span class="line"><span class="cl">+--------------------+---------------------------------------------+
</span></span><span class="line"><span class="cl">| uuid               | segmentruntime-0897fb3696cf                 |
</span></span><span class="line"><span class="cl">| segment_id         | /infra/segments/seg-preserveclientip-sedata |
</span></span><span class="line"><span class="cl">| name               | seg-preserveclientip-sedata                 |
</span></span><span class="line"><span class="cl">| subnet             | 192.168.255.16/28                           |
</span></span><span class="line"><span class="cl">| dhcp_enabled       | True                                        |
</span></span><span class="line"><span class="cl">| nw_ref             | seg-preserveclientip-sedata                 |
</span></span><span class="line"><span class="cl">| nw_name            | seg-preserveclientip-sedata                 |
</span></span><span class="line"><span class="cl">| vrf_context_ref    | t1-preserveclientip-test                    |
</span></span><span class="line"><span class="cl">| tier1_id           | /infra/tier-1s/t1-preserveclientip-test     |
</span></span><span class="line"><span class="cl">| opaque_network_id  | d509b42e-5db6-4458-9543-17a582fe1e40        |
</span></span><span class="line"><span class="cl">| segment_gw         | 192.168.255.17/28                           |
</span></span><span class="line"><span class="cl">| dhcp_ranges[1]     | 192.168.255.19-192.168.255.30               |
</span></span><span class="line"><span class="cl">| segname            | seg-preserveclientip-sedata                 |
</span></span><span class="line"><span class="cl">| tenant_ref         | admin                                       |
</span></span><span class="line"><span class="cl">| cloud_ref          | nsx.lab.home                                |
</span></span><span class="line"><span class="cl">| security_only_nsxt | False                                       |
</span></span><span class="line"><span class="cl">+--------------------+---------------------------------------------+
</span></span></code></pre></div><p>The next output shows the desired configuration for the network service configuration, where <code>192.168.255.18</code> is the floating IP. Other parameters like the SE Group reference, the VRF reference and the Cloud reference needs to be configured as well for the network service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">[admin:10-0-1-18]: &gt; show networkservice nsxtpreserveclientip_sedata
</span></span><span class="line"><span class="cl">+--------------------------------+-----------------------------------------------------+
</span></span><span class="line"><span class="cl">| Field                          | Value                                               |
</span></span><span class="line"><span class="cl">+--------------------------------+-----------------------------------------------------+
</span></span><span class="line"><span class="cl">| uuid                           | networkservice-26edbb45-5524-41a9-8abb-87250ab31494 |
</span></span><span class="line"><span class="cl">| name                           | nsxtpreserveclientip_sedata                         |
</span></span><span class="line"><span class="cl">| se_group_ref                   | seg-preserve-clientip                               |
</span></span><span class="line"><span class="cl">| vrf_ref                        | t1-preserveclientip-test                            |
</span></span><span class="line"><span class="cl">| service_type                   | ROUTING_SERVICE                                     |
</span></span><span class="line"><span class="cl">| routing_service                |                                                     |
</span></span><span class="line"><span class="cl">|   enable_routing               | False                                               |
</span></span><span class="line"><span class="cl">|   routing_by_linux_ipstack     | False                                               |
</span></span><span class="line"><span class="cl">|   floating_intf_ip[1]          | 192.168.255.18                                      |
</span></span><span class="line"><span class="cl">|   enable_vmac                  | False                                               |
</span></span><span class="line"><span class="cl">|   enable_vip_on_all_interfaces | True                                                |
</span></span><span class="line"><span class="cl">|   advertise_backend_networks   | False                                               |
</span></span><span class="line"><span class="cl">|   graceful_restart             | False                                               |
</span></span><span class="line"><span class="cl">|   enable_auto_gateway          | False                                               |
</span></span><span class="line"><span class="cl">| tenant_ref                     | admin                                               |
</span></span><span class="line"><span class="cl">| cloud_ref                      | nsx.lab.home                                        |
</span></span><span class="line"><span class="cl">+--------------------------------+-----------------------------------------------------+
</span></span></code></pre></div><p>To execute the configuration, you need to switch to the config context of the network service by using the following command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">configure networkservice &lt;somename&gt;
</span></span></code></pre></div><p>There you can configure the desired configuration parameters.</p>
<p>After the network service is created you can proceed configure the LoadBalancing Service to enable the preserve client IP feature.
Therefore it is required to configure a new application profile with preserve client IP enabled. YOu are also allowed to adjust a existing application profile, but I would recommend to create a dedicated profile.
For the application profile you need to take care, if you want to enable preserve Client IP for L7 or L4 services. If you want to enable it for an L4 service, you need to configure the L4 application profile. If you are trying to configure a L7 service, just create a L7 application profile.</p>
<p>The following screenshots visulizes the configuration parameters for a L4 application profile.</p>
<p><a href="applicationprofilel4.png"><img src="applicationprofilel4.png" alt="application-profile"></a></p>
<p>After the application profile is created, you need to assign it in the specific virtual service, weher preserve client Ip should be enabled.</p>
<p><a href="virtualservicel4.png"><img src="virtualservicel4.png" alt="virtual-service"></a></p>
<p>As last step you should validate, if you backend pool is configured with a NSX security group, which discovers the logical port of the backend applications. If the IP for the pool member is added manually in AVI, the service insertion cannot be applied.
The following screenshot shows a example configuration of a well configured pool assignment.</p>
<p><a href="pool-securitygroup.png"><img src="pool-securitygroup.png" alt="virtual-service"></a></p>
<h2 id="testing">Testing<a href="#testing" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>For my tests I have teh following steup:</p>
<ul>
<li>LoadBalancer VIP: 10.100.11.10</li>
<li>Alpine IP: 10.100.12.2</li>
<li>ClientIP: 192.168.178.226</li>
<li>Test Protocol: SSH</li>
<li>Validating which IP arrives at the backend application: <code>tcpdump -i eth0 port 22</code></li>
</ul>
<p>The following screenshot proved that the client IP is forwarded to the alpine.</p>
<p><a href="tcpdump.png"><img src="tcpdump.png" alt="virtual-service"></a></p>
<p>Further the following command shows the ssh connection in the session table of the T1 service router.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">nsxe01(tier1_sr[3])&gt; get firewall connection state
</span></span><span class="line"><span class="cl">Sat Jan 11 2025 UTC 02:27:58.672
</span></span><span class="line"><span class="cl">Connection count: 1
</span></span><span class="line"><span class="cl">192.168.178.26:59870  -&gt; 10.100.11.10:22  dir in protocol tcp state ESTABLISHED:ESTABLISHED f-8168 n-0
</span></span></code></pre></div><h2 id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Under normal circumstances the configuration should work, if all of the requirements are fulfilled, but at some point you might have the situation it will not work. In such a situation it is important to understand how the specific setup can be analyzed to check, if the service insertion is working or not.</p>
<p>I spent some time to find how to get some insights regarding the packet hits or where a packet capture would be helpful. So far, I just found the following command to see the packet hits for the configured service insertion.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">nsxe01&gt; get service-insertion
</span></span><span class="line"><span class="cl">Sat Jan 11 2025 UTC 02:14:11.958
</span></span><span class="line"><span class="cl">Service Insertion Policy:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Policy UUID                                  : ab15ceaf-5c0c-4aeb-9efb-1b28d760fe2b
</span></span><span class="line"><span class="cl">Transport type                               : L3_ROUTED
</span></span><span class="line"><span class="cl">Is EW policy                                 : 0
</span></span><span class="line"><span class="cl">Redirected packet count                      : 10
</span></span><span class="line"><span class="cl">Nexthop IP                                   : 192.168.255.18
</span></span></code></pre></div><p>As you can see, there is a parameter for <code>Redirected packet count</code> which increases, if the connection is working as expected. If the backend pool member is not configured properly, the packet count will not be increased after testing the communication.</p>
<h2 id="observations">Observations<a href="#observations" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>As soon as preserve client IP is configured for a LoadBalancing service based on service insertion for a NSX-T Overlay implementation with the NSX cloud, the backend application is no longer directly available over the same protocol and port.
In my example I configured the LoadBalancing service for SSH and the command <code>ssh 10.100.12.2</code> is running in an timeout, but ICMP is still working.</p>

			</div>
			

<div class="related-posts thin">
	<h2>See Also</h2>
	<ul>
	
	<li><a href="/posts/multitep-ha/">Improving NSX Datacenter TEP performance and availability - Multi-TEP and TEP Group High Availability</a></li>
	
	<li><a href="/posts/antrea-egress/">Antrea Egress - Controlling the egress IPs for K8s Pods within Tanzu</a></li>
	
	</ul>
</div>

		</article>
		<div class="post-nav thin">
			<a class="prev-post" href="https://sdn-techtalk.com/posts/multitep-ha/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right">
      <line x1="5" y1="12" x2="19" y2="12"></line>
      <polyline points="12 5 19 12 12 19"></polyline>
   </svg></span><br><span>Improving NSX Datacenter TEP performance and availability - Multi-TEP and TEP Group High Availability</span>
			</a>
		</div>
		<div id="comments" class="thin"></div>
	</main>

<footer id="site-footer" class="section-inner thin animated fadeIn faster">
	<p>
		&copy; 2025 <a href="https://sdn-techtalk.com/">Steven Schramm</a>
		&#183; COPYRIGHT Steven Schramm
		&#183; <a href="https://sdn-techtalk.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
   stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss">
   <path d="M4 11a9 9 0 0 1 9 9"></path>
   <path d="M4 4a16 16 0 0 1 16 16"></path>
   <circle cx="5" cy="19" r="1"></circle>
</svg></a></p>

</footer>
<script async src="https://sdn-techtalk.com/js/bundle.min.c7c384e4d29d192bbac6811ae4660bb01767194a5bea56baca77e8260f93ea16.js" integrity="sha256-x8OE5NKdGSu6xoEa5GYLsBdnGUpb6la6ynfoJg+T6hY=" crossorigin="anonymous"></script><script async src="https://sdn-techtalk.com/js/link-share.min.24409a4f6e5537d70ffc55ec8f9192208d718678cb8638585342423020b37f39.js" integrity="sha256-JECaT25VN9cP/FXsj5GSII1xhnjLhjhYU0JCMCCzfzk=" crossorigin="anonymous"></script>
</body>

</html>
